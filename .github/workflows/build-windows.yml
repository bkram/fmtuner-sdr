name: Build (Windows)

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies (vcpkg)
      shell: pwsh
      run: |
        if (-not $env:VCPKG_INSTALLATION_ROOT) {
          if (Test-Path "C:\vcpkg") {
            $env:VCPKG_INSTALLATION_ROOT = "C:\vcpkg"
          } else {
            throw "VCPKG_INSTALLATION_ROOT is not set and C:\vcpkg was not found."
          }
        }
        & "$env:VCPKG_INSTALLATION_ROOT\vcpkg.exe" install portaudio:x64-windows openssl:x64-windows

    - name: Build
      shell: pwsh
      run: |
        $toolchain = "$env:VCPKG_INSTALLATION_ROOT\scripts\buildsystems\vcpkg.cmake"
        cmake -S . -B build -DFM_TUNER_ENABLE_PORTAUDIO=ON -DCMAKE_TOOLCHAIN_FILE="$toolchain" -DVCPKG_TARGET_TRIPLET=x64-windows
        cmake --build build --config Release

    - name: Bundle runtime dependencies
      shell: pwsh
      run: |
        $dist = "dist/windows"
        New-Item -ItemType Directory -Force -Path $dist | Out-Null
        Copy-Item "build/Release/fm-tuner-sdr.exe" $dist -Force

        $vcpkgBin = "$env:VCPKG_INSTALLATION_ROOT\installed\x64-windows\bin"
        if (-not (Test-Path $vcpkgBin)) {
          throw "vcpkg runtime bin directory not found: $vcpkgBin"
        }

        Copy-Item (Join-Path $vcpkgBin "libssl-3-x64.dll") $dist -Force
        Copy-Item (Join-Path $vcpkgBin "libcrypto-3-x64.dll") $dist -Force

        $portaudioDllCandidates = @("portaudio.dll", "portaudio_x64.dll")
        $portaudioFound = $false
        foreach ($dll in $portaudioDllCandidates) {
          $src = Join-Path $vcpkgBin $dll
          if (Test-Path $src) {
            Copy-Item $src $dist -Force
            $portaudioFound = $true
            break
          }
        }
        if (-not $portaudioFound) {
          throw "Could not locate PortAudio runtime DLL in $vcpkgBin"
        }

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: fmtuner-sdr-windows
        path: dist/windows
