name: Build (Windows)

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build-mingw:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup MSYS2 (MinGW-w64)
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          git
          make
          mingw-w64-x86_64-toolchain
          mingw-w64-x86_64-cmake
          mingw-w64-x86_64-ninja
          mingw-w64-x86_64-pkgconf
          mingw-w64-x86_64-openssl
          mingw-w64-x86_64-rtl-sdr

    - name: Build and install liquid-dsp (MinGW-w64)
      shell: msys2 {0}
      run: |
        git clone --depth 1 https://github.com/jgaeddert/liquid-dsp.git /tmp/liquid-dsp
        cmake -S /tmp/liquid-dsp -B /tmp/liquid-dsp/build -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_SHARED_LIBS=OFF \
          -DBUILD_EXAMPLES=OFF \
          -DBUILD_AUTOTESTS=OFF \
          -DBUILD_BENCHMARKS=OFF \
          -DBUILD_SANDBOX=OFF \
          -DCMAKE_INSTALL_PREFIX=/mingw64
        cmake --build /tmp/liquid-dsp/build --parallel
        cmake --install /tmp/liquid-dsp/build

    - name: Build (MinGW-w64)
      shell: msys2 {0}
      run: |
        cmake -S . -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DFM_TUNER_ENABLE_X86_AVX2=OFF
        cmake --build build --parallel

    - name: Smoke test CLI (MinGW-w64)
      shell: msys2 {0}
      run: |
        ./build/fm-sdr-tuner.exe --help

    - name: Bundle runtime dependencies (MinGW-w64)
      shell: msys2 {0}
      run: |
        mkdir -p dist/windows-mingw
        cp build/fm-sdr-tuner.exe dist/windows-mingw/
        cp README.md dist/windows-mingw/
        cp fm-sdr-tuner.ini dist/windows-mingw/

        mapfile -t deps < <(
          ldd build/fm-sdr-tuner.exe \
            | awk 'tolower($0) ~ /=> \/mingw64\/bin\/.*\.dll/ {print $3}' \
            | sort -u
        )

        {
          echo "Required MinGW DLL dependencies for build/fm-sdr-tuner.exe:"
          ldd build/fm-sdr-tuner.exe
          echo
          echo "Copied DLL files:"
        } > dist/windows-mingw/dependencies.txt

        for dep in "${deps[@]}"; do
          if [ -f "$dep" ]; then
            cp "$dep" dist/windows-mingw/
            echo "$(basename "$dep") <- $dep" >> dist/windows-mingw/dependencies.txt
          fi
        done

        {
          echo
          echo "Packaged directory contents:"
          ls -1 dist/windows-mingw
        } >> dist/windows-mingw/dependencies.txt

        cat dist/windows-mingw/dependencies.txt

    - name: Smoke test packaged artifact (MinGW-w64)
      shell: msys2 {0}
      run: |
        cd dist/windows-mingw
        ./fm-sdr-tuner.exe --help
        if ldd ./fm-sdr-tuner.exe | grep -qi "not found"; then
          echo "ERROR: Packaged executable has missing shared library dependencies"
          ldd ./fm-sdr-tuner.exe
          exit 1
        fi

    - name: Upload artifact (MinGW-w64)
      uses: actions/upload-artifact@v4
      with:
        name: fm-sdr-tuner-windows-mingw
        path: dist/windows-mingw
