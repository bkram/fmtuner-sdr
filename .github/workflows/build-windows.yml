name: Build (Windows)

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build-msvc:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies (vcpkg)
      shell: pwsh
      run: |
        if (-not $env:VCPKG_INSTALLATION_ROOT) {
          if (Test-Path "C:\vcpkg") {
            $env:VCPKG_INSTALLATION_ROOT = "C:\vcpkg"
          } else {
            throw "VCPKG_INSTALLATION_ROOT is not set and C:\vcpkg was not found."
          }
        }
        $vcpkg = "$env:VCPKG_INSTALLATION_ROOT\vcpkg.exe"
        & $vcpkg install openssl:x64-windows
        if ($LASTEXITCODE -ne 0) {
          throw "Failed to install openssl via vcpkg"
        }

        # liquid-dsp is marked unsupported on Windows in vcpkg;
        # we still attempt install because the project requires it for current RDS path.
        & $vcpkg install liquid-dsp:x64-windows --allow-unsupported
        if ($LASTEXITCODE -ne 0) {
          throw "Failed to install liquid-dsp via vcpkg (with --allow-unsupported)"
        }

        & $vcpkg install rtlsdr:x64-windows
        if ($LASTEXITCODE -ne 0) {
          & $vcpkg install librtlsdr:x64-windows
          if ($LASTEXITCODE -ne 0) {
            throw "Failed to install rtl-sdr package via vcpkg (tried rtlsdr and librtlsdr)"
          }
        }

    - name: Build
      shell: pwsh
      run: |
        $toolchain = "$env:VCPKG_INSTALLATION_ROOT\scripts\buildsystems\vcpkg.cmake"
        cmake -S . -B build -DCMAKE_TOOLCHAIN_FILE="$toolchain" -DVCPKG_TARGET_TRIPLET=x64-windows
        cmake --build build --config Release

    - name: Bundle runtime dependencies
      shell: pwsh
      run: |
        $dist = "dist/windows"
        New-Item -ItemType Directory -Force -Path $dist | Out-Null
        Copy-Item "build/Release/fm-sdr-tuner.exe" $dist -Force

        $vcpkgBin = "$env:VCPKG_INSTALLATION_ROOT\installed\x64-windows\bin"
        if (-not (Test-Path $vcpkgBin)) {
          throw "vcpkg runtime bin directory not found: $vcpkgBin"
        }

        Copy-Item (Join-Path $vcpkgBin "libssl-3-x64.dll") $dist -Force
        Copy-Item (Join-Path $vcpkgBin "libcrypto-3-x64.dll") $dist -Force

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: fm-sdr-tuner-windows-msvc
        path: dist/windows

  build-mingw:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup MSYS2 (MinGW-w64)
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          git
          make
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-cmake
          mingw-w64-x86_64-ninja
          mingw-w64-x86_64-pkgconf
          mingw-w64-x86_64-openssl
          mingw-w64-x86_64-rtl-sdr

    - name: Build and install liquid-dsp (MinGW-w64)
      shell: msys2 {0}
      run: |
        git clone --depth 1 https://github.com/jgaeddert/liquid-dsp.git /tmp/liquid-dsp
        cmake -S /tmp/liquid-dsp -B /tmp/liquid-dsp/build -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=/mingw64
        cmake --build /tmp/liquid-dsp/build -j$(nproc)
        cmake --install /tmp/liquid-dsp/build

    - name: Build (MinGW-w64)
      shell: msys2 {0}
      run: |
        cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
        cmake --build build -j$(nproc)

    - name: Bundle runtime dependencies (MinGW-w64)
      shell: msys2 {0}
      run: |
        mkdir -p dist/windows-mingw
        cp build/fm-sdr-tuner.exe dist/windows-mingw/

        # Common runtime DLLs for MinGW builds
        for dll in \
          libgcc_s_seh-1.dll \
          libstdc++-6.dll \
          libwinpthread-1.dll \
          libssl-3-x64.dll \
          libcrypto-3-x64.dll \
          librtlsdr.dll \
          libliquid.dll; do
          if [ -f "/mingw64/bin/$dll" ]; then
            cp "/mingw64/bin/$dll" dist/windows-mingw/
          fi
        done

    - name: Upload artifact (MinGW-w64)
      uses: actions/upload-artifact@v4
      with:
        name: fm-sdr-tuner-windows-mingw
        path: dist/windows-mingw
